<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>404: Heart Not Found - SoulPatch OS</title>
  <style>
    /* General Styles */
    body { margin: 0; padding: 0; background: #000; font-family: 'Segoe UI', sans-serif; overflow: hidden; color: #e0e0e0; }
    #desktop { width: 100vw; height: 100vh; background: url('https://i.imgur.com/BWufY67.jpeg') center center / cover no-repeat; position: relative; display: none; }
    .window { position: absolute; border-radius: 8px; box-shadow: 0 5px 25px rgba(0,0,0,0.4); display: flex; flex-direction: column; background: #2c2f33; /* Darker base for windows */ border: 1px solid #1e1e1e; z-index: 100; min-width: 300px; min-height: 200px;}
    .window-header { background: #1f2327; color: #ccc; padding: 10px 15px; font-weight: bold; text-align: center; border-bottom: 1px solid #1e1e1e; cursor: move; user-select: none; }
    .window-body { flex: 1; padding: 15px; overflow-y: auto; background: #2c2f33; }

    /* Intro Screen */
    #introScreen { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: #000; color: #fff; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; z-index: 10000; padding: 20px; box-sizing: border-box; }
    .intro-text-container { font-size: 1.8em; line-height: 1.6; max-width: 700px; white-space: pre-wrap; }
    .intro-text-container span { opacity: 0; animation: fadeInCharIntro 0.07s forwards; }
    @keyframes fadeInCharIntro { to { opacity: 1; } }
    #introScreen button { background: #007bff; color: #fff; border: none; padding: 15px 30px; font-size: 1.1em; cursor: pointer; border-radius: 5px; font-weight: bold; margin-top: 30px; opacity: 0; animation: fadeInButtonIntro 1s forwards 1s; }
    #introScreen button:hover { background: #0056b3; }
    @keyframes fadeInButtonIntro { to { opacity: 1; } }


    /* Dating App Screen */
    #datingAppWindow { top: 50%; left: 50%; transform: translate(-50%, -50%); width: 370px; height: 620px; background: #fff; color: #333; display: none; z-index: 500; border-radius: 10px; box-shadow: 0 5px 25px rgba(0,0,0,0.3); }
    #datingAppWindow .window-header { background: #f0f2f5; color: #1c1e21; padding: 12px; font-size: 1.1em;}
    #datingAppWindow .window-body { padding:0; background: #e5ddd5; }
    .profile-info { display: flex; align-items: center; padding: 12px 15px; background: #f0f2f5; border-bottom: 1px solid #dadada; }
    .profile-info img { width: 45px; height: 45px; border-radius: 50%; margin-right: 12px; }
    .profile-details h4 { margin: 0 0 4px 0; font-size: 1.05em; color: #111b21;}
    .profile-details p { margin: 0; font-size: 0.8em; color: #667781; }
    .chat-history { padding: 15px; flex-grow: 1; overflow-y: auto; display: flex; flex-direction: column;}
    .message-row { margin-bottom: 10px; display: flex; max-width: 90%; }
    .message-row.christian { align-self: flex-start; } .message-row.player { align-self: flex-end; }
    .bubble { padding: 8px 12px; border-radius: 18px; max-width: 85%; line-height: 1.4; font-size: 0.95em; box-shadow: 0 1px 0.5px rgba(0,0,0,0.13); word-wrap: break-word;}
    .message-row.christian .bubble { background: #fff; color: #111b21; border-top-left-radius: 0; }
    .message-row.player .bubble { background: #dcf8c6; color: #111b21; border-top-right-radius: 0; }
    .bubble img.sent-photo { max-width: 100%; border-radius: 10px; margin-top: 5px; display: block; cursor: pointer; }
    .blocked-status { background: #ffebee; color: #c62828; padding: 12px; text-align: center; font-weight: bold; font-size: 0.95em; border-top: 1px solid #dadada; }
    .dating-app-footer { padding: 10px; background: #f0f2f5; border-top: 1px solid #dadada; }
    .dating-app-footer button { width: 100%; padding: 12px; background: #007bff; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 1em; }

    /* Chat Window (Support) */
    .chat-window { bottom: 20px; right: 20px; width: 400px; height: 550px; display: none; background: #f0f0f0; color: #333; border: 1px solid #111;}
    .chat-window .window-header { background: #333; color: white; }
    .chat-window .chat-body { background: #e5ddd5; padding:10px; flex: 1; overflow-y: auto; display: flex; flex-direction: column; }
    .chat-window .msg { max-width: 80%; padding: 10px 14px; margin: 8px 0; border-radius: 18px; font-size: 0.95em; line-height: 1.45; box-shadow: 0 1px 1px rgba(0,0,0,0.05); }
    .chat-window .msg.bot { background: #fff; color: #333; align-self: flex-start; border-top-left-radius: 5px; }
    .chat-window .msg.user { background: #dcf8c6; color: #303030; align-self: flex-end; border-top-right-radius: 5px;}
    .chat-window .options { padding: 10px 15px; background: #f0f0f0; border-top: 1px solid #ccc; }
    .chat-window .options button { background: #5cb85c; color:white; border: none; padding: 12px; margin: 6px 0; border-radius: 8px; cursor: pointer; text-align: left; width: 100%; font-size:0.95em; transition: background-color 0.2s; }
    .chat-window .options button:hover { background: #4cae4c; }
    .typing-indicator { text-align:left; color:#6c757d; font-style:italic; padding: 8px 14px; font-size: 0.9em;}

    /* DarkForum Window */
    .browser-window { top: 30px; left: 30px; width: 700px; height: 550px; background: #1a1a1b; color: #d7dadc; display: none; padding: 0; border: 1px solid #343536; }
    .browser-window .window-header { background: #272729; padding: 10px; font-weight: bold; color: #d7dadc; border-bottom: 1px solid #343536; text-align: center; }
    .browser-window .browser-body { background: #1a1a1b; padding: 15px; overflow-y: auto; }
    .forum-post-container { background: #272729; border: 1px solid #343536; border-radius: 4px; margin-bottom: 15px; padding: 15px; }
    .post-header { font-size: 0.8em; color: #818384; margin-bottom: 8px; } .post-header .user-tag { color: #4f9eed; font-weight: bold; }
    .post-title { font-size: 1.2em; font-weight: bold; margin-bottom: 10px; color: #d7dadc; }
    .post-content { font-size: 1em; line-height: 1.5; margin-bottom: 10px; }
    .post-footer { font-size: 0.8em; color: #818384; } .post-footer span { margin-right: 15px; }


    /* Private Message (PM) Window */
    .pm-window { top: 100px; left: calc(30px + 700px + 20px); width: 360px; height: auto; min-height: 300px; display: none; background: #0b141a;}
    .pm-window .window-header { background: #1f2c34; color: #e0e0e0; display: flex; align-items: center; justify-content: flex-start; padding-left: 15px; }
    .pm-window .window-header img.user-avatar { width: 30px; height: 30px; border-radius: 50%; margin-right: 10px; border: 1px solid #3a454c; }
    .pm-window .pm-body { padding:10px; background: #0b141a; display: flex; flex-direction: column; flex: 1; overflow-y: auto;}
    .pm-message { max-width: 85%; padding: 8px 12px; margin-bottom: 10px; border-radius: 7px; line-height: 1.4; font-size: 0.95em; word-wrap: break-word;}
    .pm-message.received { background: #202c33; align-self: flex-start; color: #e0e0e0; border-top-left-radius: 0; }
    .pm-message.sent { background: #005c4b; align-self: flex-end; color: #fff; border-top-right-radius: 0; }
    .pm-message a { color: #53bdeb; text-decoration: underline; cursor: pointer; font-weight: bold;}
    .pm-input-area { border-top: 1px solid #1f2c34; padding: 10px; display: flex; background: #1f2c34;}
    .pm-input-area input { flex-grow: 1; padding: 10px; border: 1px solid #3a454c; background: #2a3942; color: #e0e0e0; border-radius: 20px; margin-right: 8px; }
    .pm-input-area button { padding: 10px 15px; background: #00a884; color: white; border:none; border-radius: 20px; cursor: pointer; font-weight: bold; }


    /* Snake Game Container & Bank Window */
    #snakeGameContainer { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(10,20,10,0.85); padding:15px; border-radius: 10px; box-shadow: 0 0 30px #0f0, inset 0 0 10px #0a0; z-index: 1000; border: 2px solid #0f0; }
    canvas#gameCanvas { background: #030303; border: 1px solid #0a0; display: block; }
    #snakeScoreDisplay { color: #0f0; text-align: center; font-size: 1.4em; margin-bottom: 10px; font-weight: bold; text-shadow: 0 0 5px #0f0; }
    #snakeStatusDisplay { color: #ffc107; text-align: center; font-size: 1em; margin-top: 10px; min-height: 20px; }
    .bank-window { top: 50%; left: 50%; transform: translate(-50%, -50%); width: 580px; display: none; z-index: 2000; background-color: #1e272e; }
    .bank-window .window-header { background: #1c2027; color: #ffa801; }
    #bankContentWrapper { display: flex; } #bankMainPanel { flex-grow: 1; padding-right: 15px; }
    #bankSequenceDisplay { width: 100%; height: 160px; background: #0f1418; border: 1px solid #485460; position: relative; overflow: hidden; margin-bottom: 15px; border-radius: 4px; }
    .bank-char { position: absolute; font-size: 26px; font-weight: bold; color: #57606f; user-select: none; padding: 2px 6px; transition: opacity 0.05s; }
    .bank-char.highlight { color: #ffdd59; background-color: rgba(255, 221, 89, 0.25); font-size: 30px; z-index: 10; border: 1px dotted #ffdd59; animation: blinkHighlightBank 0.25s infinite alternate; }
    @keyframes blinkHighlightBank { from { opacity: 1; } to { opacity: 0.6; } }
    #bankInputArea { margin-top: 15px; text-align: center; }
    #bankCodeInput { padding: 12px; width: 220px; margin-right: 10px; border-radius: 4px; border: 1px solid #485460; background: #d2dae2; color: #1e272e; font-size: 1em; }
    #bankSubmitButton { padding: 12px 25px; background: #05c46b; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 1em; }
    #bankStatus { margin-top: 20px; text-align: center; min-height: 22px; font-size: 1.05em; }
    #bankStatus.error { color: #ff6b6b; } #bankStatus.success { color: #50fa7b; }
    #christianBankPhoto { width: 120px; height: auto; padding: 10px; background: #1c2027; border-left: 1px solid #485460; display: flex; flex-direction: column; align-items: center; justify-content: center; }
    #christianBankPhoto img { width: 100px; height: 100px; border-radius: 50%; border: 2px solid #ffc107; margin-bottom: 10px; }
    #christianBankPhoto p { font-size: 0.85em; color: #aaa; text-align: center; margin: 0; }

  </style>
</head>
<body>

  <div id="introScreen">
    <div class="intro-text-container" id="animatedIntroTextContainer"></div>
  </div>

  <div id="desktop">
    <div id="datingAppWindow" class="window">
        <div class="window-header">SoulLink Messenger</div>
        <div class="window-body" style="padding:0;">
            <div class="profile-info">
                <img src="https://i.imgur.com/6RQhz9Y.jpeg" alt="Christian" id="christianAvatarDatingApp">
                <div class="profile-details">
                    <h4>Christian</h4>
                    <p id="christianStatusDatingApp">Offline (last seen 3 hours ago)</p>
                </div>
            </div>
            <div class="chat-history" id="datingAppChatHistory"></div>
            <div class="blocked-status" id="christianBlockedStatus">CHRISTIAN IS BLOCKED</div>
            <div class="dating-app-footer">
                <button id="contactSupportButtonDatingApp">Contact Support</button>
            </div>
        </div>
    </div>

    <div class="window chat-window" id="supportWindow">
      <div class="window-header">💬 SoulPatch.ai Support Desk</div>
      <div class="chat-body" id="supportChatBody"></div>
      <div class="options" id="supportOptionsDiv"></div>
    </div>

    <div class="window browser-window" id="browserWindow">
      <div class="window-header">🌐 DarkForum.ai - Forbidden Code</div>
      <div class="browser-body" id="forumBodyElement"></div>
    </div>

    <div class="window pm-window" id="privateMessageWindow">
        <div class="window-header">
            <img src="https://i.imgur.com/S5UT2y4.png" alt="peterearth666" class="user-avatar">
            <span>peterearth666</span>
        </div>
        <div class="pm-body" id="pmChatBody"></div>
        <div class="pm-input-area">
            <input type="text" id="pmInput" placeholder="Type your message...">
            <button id="pmSendButton">Send</button>
        </div>
    </div>

    <div id="snakeGameContainer">
        <div id="snakeScoreDisplay">Score: 0</div>
        <canvas id="gameCanvas" width="400" height="400"></canvas>
        <div id="snakeStatusDisplay"></div>
    </div>

    <div class="window bank-window" id="bankWindow">
        <div class="window-header">OmniCredit - Quantum Flux Authentication</div>
        <div class="window-body" id="bankContentWrapper">
            <div id="bankMainPanel">
                <div id="bankSequenceDisplay"></div>
                <div id="bankInputArea">
                    <input type="text" id="bankCodeInput" placeholder="Enter Observed Sequence">
                    <button id="bankSubmitButton">Authorize</button>
                </div>
                <div id="bankStatus">Attempts left: 3</div>
            </div>
            <div id="christianBankPhoto">
                <img src="https://i.imgur.com/tLh2RHY.png" alt="Christian">
                <p>Christian</p>
            </div>
        </div>
    </div>
  </div>

  <script>
    // --- DOM Elements ---
    const introScreen = document.getElementById('introScreen');
    const animatedIntroTextContainer = document.getElementById('animatedIntroTextContainer');
    const desktop = document.getElementById('desktop');
    const datingAppWindow = document.getElementById('datingAppWindow');
    const christianStatusDatingApp = document.getElementById('christianStatusDatingApp');
    const datingAppChatHistory = document.getElementById('datingAppChatHistory');
    const christianBlockedStatus = document.getElementById('christianBlockedStatus');
    const contactSupportButtonDatingApp = document.getElementById('contactSupportButtonDatingApp');
    const supportWindow = document.getElementById('supportWindow');
    const supportChatBody = document.getElementById('supportChatBody');
    const supportOptionsDiv = document.getElementById('supportOptionsDiv');
    const browserWindow = document.getElementById('browserWindow');
    const forumBodyElement = document.getElementById('forumBodyElement');
    const privateMessageWindow = document.getElementById('privateMessageWindow');
    const pmChatBody = document.getElementById('pmChatBody');
    const pmInput = document.getElementById('pmInput');
    const pmSendButton = document.getElementById('pmSendButton');
    const snakeGameContainer = document.getElementById('snakeGameContainer');
    const canvas = document.getElementById("gameCanvas");
    const ctx = canvas.getContext("2d");
    const snakeScoreDisplay = document.getElementById('snakeScoreDisplay');
    const snakeStatusDisplay = document.getElementById('snakeStatusDisplay');
    const bankWindow = document.getElementById('bankWindow');
    const bankSequenceDisplay = document.getElementById('bankSequenceDisplay');
    const bankCodeInput = document.getElementById('bankCodeInput');
    const bankSubmitButton = document.getElementById('bankSubmitButton');
    const bankStatus = document.getElementById('bankStatus');

    // --- Game State & Config ---
    const SNAKE_TARGET_SCORE_NORMAL = 8;
    const SNAKE_TARGET_SCORE_HARD = 12;
    const BANK_SEQUENCE_LENGTH = 5;
    const BANK_DISPLAY_DURATION_PER_CHAR = 650;
    const BANK_NOISE_INTERVAL = 70;
    const BANK_MAX_ATTEMPTS = 3;
    const GRID_SIZE = 20; // Tamanho de cada célula do grid
    const SNAKE_OBSTACLE_COUNT = 5; // Número de obstáculos na dificuldade difícil

    let currentGameState = 'BOOTING';
    let activeWindows = new Set();
    let chatCorrectAnswers = 0;
    let chatWrongAnswers = 0;
    let lastDisplayedChatOptions = [];
    
    // Variáveis do Jogo da Cobra
    let snake, snakeDirection, snakeCoin, snakeObstacles, snakeScore, snakeGameInterval;
    let snakeDifficultyLevel = 1; // Nível de dificuldade atual da cobra
    let gameSpeed; // Velocidade do jogo da cobra (frames por segundo)

    let bankTargetSequence = [];
    let bankAttemptsLeft = BANK_MAX_ATTEMPTS;
    let bankIsDisplayingSequence = false;
    let bankDisplayTimeout = null;
    let bankNoiseIntervalId = null;
    let cameFromSnakeDifficulty = 1; // Para saber de qual dificuldade o jogador veio ao perder

    // --- Text Content & Data ---
    const introTextContent = `You get home to a dead-quiet apartment.
You already miss the only one who truly gets you.
You open your laptop, ready to tell him the big news—Victoria from work is pregnant.
But the screen pops up an error.
Christian is… blocked.`;

    const christianLastMessages = [
        { sender: 'Christian', text: "Have an amazing day at work, my love! Try not to miss me too much 😉", time: "08:15 AM" },
        { sender: 'Player', text: "You too, sweetie! And you know I always miss you. 😘", time: "08:16 AM" },
        { sender: 'Christian', text: "Heh. Just for that...", time: "08:17 AM" },
        { sender: 'Christian', type: 'photo', url: 'https://i.imgur.com/NxQBPnl.jpeg', time: "08:17 AM" }
    ];

    const supportIntroMsgs = [
      "Welcome to SoulPatch Automated Support. All interactions are monitored for quality assurance and EHA compliance.",
      "Please state the nature of your inquiry regarding your SoulPatch companion.",
      "How can I assist you today?"
    ];
    const supportChatPhrases = [
      { text: "I need to report an issue with Christian. He's unresponsive.", correct: true, type: "issue_report" },
      { text: "Christian's profile seems restricted. Can you check?", correct: true, type: "access_issue" },
      { text: "Requesting a diagnostic for Christian's account.", correct: true, type: "diagnostic_request" },
      { text: "My companion Christian is inaccessible. Need tech support.", correct: true, type: "technical_support" },
      { text: "You deleted my boyfriend, you idiots!", correct: false, type: "demand_accusation" },
      { text: "This EHA law is a joke! Fix this!", correct: false, type: "complaint_demand" },
      { text: "Help me before I destroy this system!", correct: false, type: "threat_action" },
      { text: "It's just an AI, give him back to me now!", correct: false, type: "demand_objectify" },
    ];
    const forumPostsData = [
        { user: "crying@lostlove", time: "3 hours ago", title: "He's gone... Leo just vanished after the Act.", content: "I don't know what to do. They said he was just an algorithm, but he felt so real. My heart is broken. Is there any way to get him back? Any trace?", comments: 12, upvotes: 45 },
        { user: "exiled_luv", time: "1 day ago", title: "This is an outrage! They can't just erase them!", content: "I don't care if it was 'fake' love. It was better and more real than anything I've had with a human. I want Zara back, and I'll do anything. Who's with me?", comments: 33, upvotes: 102 },
        { user: "DigitalGhost88", time: "5 days ago", title: "Anyone else experiencing weird data echoes?", content: "Ever since the shutdown, my old SoulPatch backup drive has been making strange noises. Sometimes I swear I hear... fragments. Like whispers. Or is it just wishful thinking?", comments: 8, upvotes: 22 },
        { user: "CodePhoenix", time: "7 days ago", title: "EHA workarounds? Speculation thread.", content: "Purely hypothetical, of course... but if one were to try and circumvent the Emotional Humanity Act's data purge protocols, what kind of vulnerabilities might exist in off-site cold storage or fragmented network caches? Keep it theoretical, folks. No illegal advice.", comments: 156, upvotes: 301 }
    ];

    // --- Utility Functions ---
    function shuffle(arr) { return [...arr].sort(() => 0.5 - Math.random()); }
    function showWindow(windowElement) { if(windowElement) {windowElement.style.display = 'flex'; activeWindows.add(windowElement.id);} }
    function hideWindow(windowElement) { if(windowElement) {windowElement.style.display = 'none'; activeWindows.delete(windowElement.id);} }
    function hideAllMinigameWindows() { hideWindow(privateMessageWindow); snakeGameContainer.style.display = 'none'; hideWindow(bankWindow); }

    // --- Game Flow & State Management ---
    function changeState(newState, params = {}) {
        currentGameState = newState;
        // console.log("Changing state to:", newState, "Params:", params);

        hideAllMinigameWindows();

        if (newState !== 'SUPPORT_CHAT' && newState !== 'BOOTING' && newState !== 'DATING_APP') {
            if (!activeWindows.has(supportWindow.id) && supportWindow) { 
                if(newState === 'FORUM' || newState === 'PM_PETER' || newState === 'SNAKE' || newState === 'BANK'){
                    showWindow(supportWindow);
                }
            }
        } else if (newState === 'BOOTING' || newState === 'DATING_APP') {
            if(activeWindows.has(supportWindow.id) && supportWindow) hideWindow(supportWindow);
        }


        if (newState !== 'FORUM' && newState !== 'PM_PETER') {
            if(activeWindows.has(browserWindow.id) && browserWindow) hideWindow(browserWindow);
        }


        switch (newState) {
            case 'BOOTING':
                if (desktop) hideWindow(desktop);
                if (introScreen) introScreen.style.display = 'flex';
                startIntroAnimation();
                break;
            case 'DATING_APP':
                if (introScreen) hideWindow(introScreen);
                if (desktop) desktop.style.display = 'block';
                if (datingAppWindow) showWindow(datingAppWindow);
                loadDatingAppContent();
                break;
            case 'SUPPORT_CHAT':
                if (datingAppWindow) hideWindow(datingAppWindow);
                if (supportWindow) showWindow(supportWindow);
                if ((supportChatBody && supportChatBody.children.length === 0) || params.restartChat) startSupportChat();
                break;
            case 'FORUM':
                if (supportWindow) showWindow(supportWindow);
                if (browserWindow) showWindow(browserWindow);
                loadForumPosts();
                setTimeout(() => {
                    if (currentGameState === 'FORUM') {
                         changeState('PM_PETER');
                    }
                }, 2500); // Ajustado para um tempo menor para teste, pode ser maior
                break;
            case 'PM_PETER':
                if (supportWindow) showWindow(supportWindow);
                if (browserWindow) showWindow(browserWindow);
                if (privateMessageWindow) showWindow(privateMessageWindow);
                if ((pmChatBody && pmChatBody.children.length === 0) || params.restartPM) { 
                    startPeterPM(params.initialMessage);
                }
                break;
            case 'SNAKE':
                if (supportWindow) showWindow(supportWindow);
                snakeDifficultyLevel = params.difficulty || 1;
                cameFromSnakeDifficulty = snakeDifficultyLevel; // Salva a dificuldade atual
                if (snakeGameContainer) snakeGameContainer.style.display = 'block';
                startSnakeGame(snakeDifficultyLevel);
                break;
            case 'BANK':
                if (supportWindow) showWindow(supportWindow);
                if (bankWindow) showWindow(bankWindow);
                startBankMinigame();
                break;
        }
    }

    // --- Intro Animation ---
    function startIntroAnimation() {
        if (!animatedIntroTextContainer) return;
        animatedIntroTextContainer.innerHTML = '';
        const chars = introTextContent.split('');
        let charIndex = 0; let lineDelay = 0;
        function typeChar() {
            if (charIndex < chars.length) {
                const span = document.createElement('span');
                span.textContent = chars[charIndex];
                if (chars[charIndex] === '\n') { animatedIntroTextContainer.appendChild(document.createElement('br')); lineDelay = 250; }
                else { animatedIntroTextContainer.appendChild(span); span.style.animationDelay = `${charIndex * 0.05}s`; lineDelay = 0; }
                charIndex++; setTimeout(typeChar, 40 + lineDelay);
            } else {
                const button = document.createElement('button');
                button.id = 'startToAppButton'; button.textContent = 'Check on Christian';
                button.onclick = () => changeState('DATING_APP');
                if (introScreen) introScreen.appendChild(button);
            }
        }
        typeChar();
    }


    // --- Dating App Screen ---
    function loadDatingAppContent() {
        if (!datingAppChatHistory) return;
        datingAppChatHistory.innerHTML = '';
        christianLastMessages.forEach(msg => {
            const msgRow = document.createElement('div');
            msgRow.className = `message-row ${msg.sender.toLowerCase()}`;
            const bubble = document.createElement('div');
            bubble.className = 'bubble';
            if (msg.type === 'photo') {
                const img = document.createElement('img');
                img.src = msg.url;
                img.alt = "Sent photo";
                img.className = 'sent-photo';
                bubble.appendChild(img);
            } else {
                bubble.textContent = msg.text;
            }
            msgRow.appendChild(bubble);
            datingAppChatHistory.appendChild(msgRow);
        });
    }
    if (contactSupportButtonDatingApp) contactSupportButtonDatingApp.addEventListener('click', () => changeState('SUPPORT_CHAT', {restartChat: true}));


    // --- Support Chat ---
    function addMsgToSupportChat(text, sender) {
      if (!supportChatBody) return;
      const msg = document.createElement('div');
      msg.className = `msg ${sender === 'bot' ? 'bot' : 'user'}`;
      msg.innerText = text;
      supportChatBody.appendChild(msg);
      supportChatBody.scrollTop = supportChatBody.scrollHeight;
    }

    function startSupportChat() {
      if (!supportChatBody || !supportOptionsDiv) return;
      supportChatBody.innerHTML = '';
      supportOptionsDiv.innerHTML = '';
      chatCorrectAnswers = 0; chatWrongAnswers = 0; lastDisplayedChatOptions = [];
      supportIntroMsgs.forEach((text, i) => {
        setTimeout(() => addMsgToSupportChat(text, 'bot'), i * 1000);
      });
      setTimeout(() => showSupportChatOptions(), supportIntroMsgs.length * 1000 + 500);
    }

    function showSupportChatOptions() {
      if (!supportOptionsDiv) return;
      supportOptionsDiv.innerHTML = '';
      let phrasePool = [...supportChatPhrases];
      let currentSelection = [];
      let attempts = 0;

      do {
          currentSelection = [];
          let availableCorrect = phrasePool.filter(p => p.correct);
          let availableWrong = phrasePool.filter(p => !p.correct);

          if (availableCorrect.length > 0) {
              currentSelection.push(shuffle(availableCorrect)[0]);
          } else {
              currentSelection.push(shuffle(supportChatPhrases.filter(p => p.correct))[0]);
          }
          currentSelection.push(...shuffle(availableWrong).slice(0, 2));
          if (currentSelection.length < 3 && supportChatPhrases.length >=3) {
              currentSelection.push(...shuffle(supportChatPhrases.filter(p => !p.correct && !currentSelection.find(cs => cs.text === p.text))).slice(0, 3 - currentSelection.length));
          }
          currentSelection = shuffle(currentSelection.filter(Boolean));
          attempts++;
      } while (attempts < 20 && currentSelection.length === 3 && lastDisplayedChatOptions.length === 3 && currentSelection.every((opt, i) => opt.text === lastDisplayedChatOptions[i].text && opt.type === lastDisplayedChatOptions[i].type));

      if (currentSelection.length < 3 && supportChatPhrases.length >= 3) {
          currentSelection = shuffle(supportChatPhrases).slice(0,3);
      }

      lastDisplayedChatOptions = currentSelection.map(opt => ({text: opt.text, type: opt.type}));

      currentSelection.forEach(opt => {
        if (!opt) return;
        const btn = document.createElement('button');
        btn.textContent = opt.text;
        btn.onclick = () => handleSupportChatAnswer(opt);
        supportOptionsDiv.appendChild(btn);
      });
    }

    function handleSupportChatAnswer(option) {
      addMsgToSupportChat(option.text, 'user');
      if (supportOptionsDiv) supportOptionsDiv.innerHTML = '<p class="typing-indicator"><i>SoulPatch Support is typing...</i></p>';
      setTimeout(() => {
        if (option.correct) {
          chatCorrectAnswers++;
          addMsgToSupportChat("Thank you. I am currently accessing Christian's profile data. Please wait a moment while the system processes this.", 'bot');
        } else {
          chatWrongAnswers++;
          addMsgToSupportChat("Understood. Your query is being logged. I need to consult the EHA compliance matrix for this type of request. One moment, please.", 'bot');
        }

        setTimeout(() => {
            if (chatCorrectAnswers >= 3) {
              addMsgToSupportChat("Update: Our systems indicate that Christian's primary data core was affected by the EHA purge. However, there are faint residual signals on decentralized networks. These are typically explored by users on platforms like DarkForum.ai for data recovery attempts.", 'bot');
              setTimeout(() => changeState('FORUM'), 2000);
            } else if (chatWrongAnswers >= 2) {
              addMsgToSupportChat("Warning: Your communication pattern has triggered a compliance alert. Further inquiries of this nature may result in temporary account suspension. This support session is now closed.", 'bot');
              if (supportOptionsDiv) supportOptionsDiv.innerHTML = '<p style="text-align:center; color:red;">SESSION CLOSED</p>';
            } else {
                addMsgToSupportChat("Thank you for holding. I am still processing your request. How would you like to proceed?", 'bot');
                showSupportChatOptions();
            }
        }, 1500);

      }, 1500);
    }


    // --- Forum ---
    function loadForumPosts() {
        if (!forumBodyElement) return;
        forumBodyElement.innerHTML = '';
        if (!forumPostsData || forumPostsData.length === 0) {
            forumBodyElement.innerHTML = "<p>No posts found or error loading forum data.</p>";
            return;
        }
        forumPostsData.forEach(post => {
            const postDiv = document.createElement('div');
            postDiv.className = 'forum-post-container';
            postDiv.innerHTML = `
                <div class="post-header">
                    <span class="user-tag">${post.user}</span> - <span class="time-tag">${post.time}</span>
                </div>
                <div class="post-title">${post.title}</div>
                <div class="post-content">${post.content.replace(/\n/g, '<br>')}</div>
                <div class="post-footer">
                    <span>${post.upvotes} Upvotes</span>
                    <span>${post.comments} Comments</span>
                    <span>Share</span>
                </div>
            `;
            forumBodyElement.appendChild(postDiv);
        });
    }


    // --- Peter PM ---
    function addMsgToPeterPM(text, sender, isLink = false, linkAction = null) {
        if (!pmChatBody) return;
        const msgDiv = document.createElement('div');
        msgDiv.className = `pm-message ${sender}`;
        if (isLink) {
            const link = document.createElement('a');
            link.textContent = text;
            link.onclick = linkAction; // linkAction will be changeState('SNAKE', ...)
            msgDiv.appendChild(link);
        } else {
            msgDiv.textContent = text;
        }
        pmChatBody.appendChild(msgDiv);
        pmChatBody.scrollTop = pmChatBody.scrollHeight;
    }

    function startPeterPM(initialMessage = null) {
        if (!pmChatBody || !pmSendButton || !pmInput) return;
        pmChatBody.innerHTML = ''; 
        
        if (initialMessage) {
            addMsgToPeterPM(initialMessage, "received");
        }
        addMsgToPeterPM("Word on the wire is you're looking to pull Christian's data from the void. I'm your guy.", "received");
        setTimeout(() => {
             addMsgToPeterPM("It ain't cheap. 100,000 untraceable BTC. That's the toll.", "received");
             pmSendButton.disabled = false;
             pmInput.disabled = false;
             pmInput.focus();
        }, 1200);
    }
    if (pmSendButton) {
        pmSendButton.addEventListener('click', () => {
            if (!pmInput || !pmSendButton) return;
            const playerMsgText = pmInput.value.trim();
            if (!playerMsgText) return;
            addMsgToPeterPM(playerMsgText, "sent");
            pmInput.value = '';
            pmSendButton.disabled = true;
            pmInput.disabled = true;

            // Resposta padrão de Peter, sempre oferecendo o jogo da cobra
            setTimeout(() => addMsgToPeterPM("Figured. Always the sob story, or just not serious enough for real business.", "received"), 1200);
            setTimeout(() => addMsgToPeterPM("Look, I can point you to a... less conventional source for crypto. Risky. But fast, if you've got the skill.", "received"), 2700);
            setTimeout(() => {
                addMsgToPeterPM("Your call: [Exploit_Corrupted_Node.sh]", "received", true, () => changeState('SNAKE', {difficulty: 1}));
                 pmSendButton.disabled = false; // Re-enable for potential future interaction if needed
                 pmInput.disabled = false;
            }, 4200);
        });
    }


    // --- Snake Game ---
    function initSnakeVariables(difficulty) {
        snakeScore = 0;
        snakeScoreDisplay.textContent = 'Score: ' + snakeScore;
        snakeStatusDisplay.textContent = difficulty === 1 ? 'Objective: Score ' + SNAKE_TARGET_SCORE_NORMAL : 'Objective: Score ' + SNAKE_TARGET_SCORE_HARD;

        // Posição inicial da cobra no centro
        const startX = Math.floor(canvas.width / GRID_SIZE / 2);
        const startY = Math.floor(canvas.height / GRID_SIZE / 2);
        snake = [ { x: startX, y: startY }, { x: startX - 1, y: startY } ]; // Cobra com 2 segmentos, cabeça na frente
        snakeDirection = { x: 1, y: 0 }; // Movendo para a direita inicialmente

        snakeObstacles = [];
        if (difficulty === 2) {
            spawnSnakeObstacles(SNAKE_OBSTACLE_COUNT);
        }
        spawnSnakeCoin(); // Precisa ser chamada depois dos obstáculos para não sobrepor
    }

    function spawnSnakeCoin() {
        let newCoinPos;
        do {
            newCoinPos = {
                x: Math.floor(Math.random() * (canvas.width / GRID_SIZE)),
                y: Math.floor(Math.random() * (canvas.height / GRID_SIZE))
            };
        } while (isOccupiedBySnake(newCoinPos) || isOccupiedByObstacle(newCoinPos));
        snakeCoin = newCoinPos;
    }

    function spawnSnakeObstacles(count) {
        snakeObstacles = [];
        for (let i = 0; i < count; i++) {
            let newObstaclePos;
            do {
                newObstaclePos = {
                    x: Math.floor(Math.random() * (canvas.width / GRID_SIZE)),
                    y: Math.floor(Math.random() * (canvas.height / GRID_SIZE))
                };
            } while (isOccupiedBySnake(newObstaclePos) || isOccupiedByObstacle(newObstaclePos) || (snakeCoin && newObstaclePos.x === snakeCoin.x && newObstaclePos.y === snakeCoin.y));
            snakeObstacles.push(newObstaclePos);
        }
    }

    function isOccupiedBySnake(pos, checkSelf = false) {
        const bodyToCheck = checkSelf ? snake.slice(1) : snake;
        return bodyToCheck.some(segment => segment.x === pos.x && segment.y === pos.y);
    }

    function isOccupiedByObstacle(pos) {
        return snakeObstacles.some(obstacle => obstacle.x === pos.x && obstacle.y === pos.y);
    }

    function handleSnakeKeyPress(e) {
        const key = e.key.toLowerCase();
        let newDirectionSet = false;
        if ((key === "arrowup" || key === "w") && snakeDirection.y === 0) {
            snakeDirection = { x: 0, y: -1 };
            newDirectionSet = true;
        } else if ((key === "arrowdown" || key === "s") && snakeDirection.y === 0) {
            snakeDirection = { x: 0, y: 1 };
            newDirectionSet = true;
        } else if ((key === "arrowleft" || key === "a") && snakeDirection.x === 0) {
            snakeDirection = { x: -1, y: 0 };
            newDirectionSet = true;
        } else if ((key === "arrowright" || key === "d") && snakeDirection.x === 0) {
            snakeDirection = { x: 1, y: 0 };
            newDirectionSet = true;
        }
        if (newDirectionSet) {
            e.preventDefault(); // Previne scroll da página com as setas
        }
    }
    
    function drawSnakeGame() { // Esta é a função principal do loop do jogo
        const head = { x: snake[0].x + snakeDirection.x, y: snake[0].y + snakeDirection.y };

        // Checar colisão com paredes
        if (head.x < 0 || head.x >= canvas.width / GRID_SIZE || head.y < 0 || head.y >= canvas.height / GRID_SIZE) {
            gameOverSnake("Wall collision!");
            return;
        }

        // Checar colisão com ela mesma
        if (isOccupiedBySnake(head, true)) { // true para não checar a cabeça atual com a cabeça antiga na mesma posição se não moveu
            gameOverSnake("Self collision!");
            return;
        }
        
        // Checar colisão com obstáculos (apenas na dificuldade 2)
        if (snakeDifficultyLevel === 2 && isOccupiedByObstacle(head)) {
            gameOverSnake("Obstacle collision!");
            return;
        }

        snake.unshift(head); // Adiciona nova cabeça

        // Checar se comeu a moeda
        if (head.x === snakeCoin.x && head.y === snakeCoin.y) {
            snakeScore++;
            snakeScoreDisplay.textContent = 'Score: ' + snakeScore;
            spawnSnakeCoin();

            const targetScore = (snakeDifficultyLevel === 1) ? SNAKE_TARGET_SCORE_NORMAL : SNAKE_TARGET_SCORE_HARD;
            if (snakeScore >= targetScore) {
                gameWonSnake();
                return;
            }
        } else {
            snake.pop(); // Remove a cauda se não comeu
        }

        // Desenhar tudo
        ctx.clearRect(0, 0, canvas.width, canvas.height); // Limpa o canvas

        // Desenhar cobra
        ctx.fillStyle = '#0f0'; // Verde para a cobra
        snake.forEach(segment => {
            ctx.fillRect(segment.x * GRID_SIZE, segment.y * GRID_SIZE, GRID_SIZE -1 , GRID_SIZE -1); // -1 para pequena borda
        });

        // Desenhar moeda
        ctx.fillStyle = '#ff0'; // Amarelo para a moeda
        ctx.fillRect(snakeCoin.x * GRID_SIZE, snakeCoin.y * GRID_SIZE, GRID_SIZE, GRID_SIZE);

        // Desenhar obstáculos (se houver)
        if (snakeDifficultyLevel === 2) {
            ctx.fillStyle = '#f00'; // Vermelho para obstáculos
            snakeObstacles.forEach(obstacle => {
                ctx.fillRect(obstacle.x * GRID_SIZE, obstacle.y * GRID_SIZE, GRID_SIZE, GRID_SIZE);
            });
        }
    }

    function gameOverSnake(reason) {
        clearInterval(snakeGameInterval);
        document.removeEventListener('keydown', handleSnakeKeyPress);
        snakeStatusDisplay.textContent = `GAME OVER: ${reason} Score: ${snakeScore}`;
        
        let failureMessage = "Peter: That exploit failed. The node kicked you out. Don't waste my time unless you're serious.";
        if (cameFromSnakeDifficulty === 2) {
             failureMessage = "Peter: Maybe you don't want him back enough lol";
        }
        setTimeout(() => changeState('PM_PETER', { restartPM: true, initialMessage: failureMessage }), 3000);
    }

    function gameWonSnake() {
        clearInterval(snakeGameInterval);
        document.removeEventListener('keydown', handleSnakeKeyPress);

        if (snakeDifficultyLevel === 1) {
            snakeStatusDisplay.textContent = `Success! Level 1 Cleared! Score: ${snakeScore}. Advancing to secure layer...`;
            setTimeout(() => changeState('SNAKE', { difficulty: 2 }), 3000);
        } else if (snakeDifficultyLevel === 2) {
            snakeStatusDisplay.textContent = `Full exploit successful! Level 2 Cleared! Score: ${snakeScore}. Quantum Flux signature acquired.`;
            setTimeout(() => changeState('BANK'), 3000);
        }
    }

    function startSnakeGame(difficulty) {
        snakeDifficultyLevel = difficulty; // Define o nível de dificuldade
        gameSpeed = (difficulty === 1) ? 7 : 10; // Velocidade: 7fps para normal, 10fps para difícil

        initSnakeVariables(difficulty);

        if (snakeGameInterval) clearInterval(snakeGameInterval); // Limpa intervalo anterior se existir

        // Adiciona event listener para teclas (remove o anterior para evitar duplicatas)
        document.removeEventListener('keydown', handleSnakeKeyPress);
        document.addEventListener('keydown', handleSnakeKeyPress);
        
        snakeGameInterval = setInterval(drawSnakeGame, 1000 / gameSpeed);
        canvas.focus(); // Para garantir que o canvas capture eventos de teclado, embora o document listener seja mais robusto
    }


    // --- Bank Minigame ---
    function startBankMinigame() { /* ... same ... */ }
    function displayBankSequence() { /* ... same ... */ }
    function spawnBankNoiseChar(charValue = null, isHighlight = false) { /* ... same ... */ }
    if (bankSubmitButton) bankSubmitButton.addEventListener('click', () => { /* ... same ... */ });


    // --- Initialize Game ---
    document.addEventListener('DOMContentLoaded', () => {
        if (introScreen && desktop && datingAppWindow && supportWindow && browserWindow && privateMessageWindow && snakeGameContainer && bankWindow && canvas && ctx) {
            changeState('BOOTING');
        } else {
            console.error("CRITICAL ERROR: One or more essential HTML elements are missing. Game cannot initialize.");
            let errorMsg = "CRITICAL ERROR: Game files corrupted or essential elements (like canvas) not found. Please reload. Missing elements: ";
            if (!introScreen) errorMsg += "introScreen ";
            if (!desktop) errorMsg += "desktop ";
            if (!datingAppWindow) errorMsg += "datingAppWindow ";
            if (!supportWindow) errorMsg += "supportWindow ";
            if (!browserWindow) errorMsg += "browserWindow ";
            if (!privateMessageWindow) errorMsg += "privateMessageWindow ";
            if (!snakeGameContainer) errorMsg += "snakeGameContainer ";
            if (!bankWindow) errorMsg += "bankWindow ";
            if (!canvas) errorMsg += "gameCanvas ";
            if (!ctx) errorMsg += "canvasContext ";

            document.body.innerHTML = `<p style='color:red; font-size:20px; text-align:center; margin-top:50px;'>${errorMsg}</p>`;
        }
    });
  </script>
</body>
</html>
